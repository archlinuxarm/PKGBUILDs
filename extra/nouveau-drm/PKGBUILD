# $Id: PKGBUILD 51572 2009-09-09 18:17:14Z andyrtr $
# Maintainer: Andreas Radke <andyrtr@archlinux.org>
# Contributor: buddabrod <buddabrod@gmail.com>

pkgname=nouveau-drm
_snapdate=20090908
pkgver=0.0.15_${_snapdate} # see drivers/gpu/drm/nouveau_drv.h for version
#_gitdate=20090908
_kernver='2.6.30-ARCH'
pkgrel=1
pkgdesc="nvidia opensource X driver"
arch=('i686' 'x86_64')
url="http://nouveau.freedesktop.org/"
depends=("kernel26>=2.6.30" "kernel26<2.6.31")
#makedepends=('git' 'autoconf' 'pkgconfig')
install=${pkgname}.install
license=('GPL')
options=('force')
source=(ftp://ftp.archlinux.org/other/$pkgname/master-compat_${_snapdate}.tar.gz
	#http://people.freedesktop.org/~pq/nouveau-drm/master-compat.tar.gz
)
md5sums=('a181adcef3ffd8806037bf883d137d4e')
  
build() {
  cd ${srcdir}/master-compat
  cd nouveau
  make DRM_MODULES="nouveau" || return 1

  install -D -m 0644 ${srcdir}/master-compat/drivers/gpu/drm/drm.ko ${pkgdir}/lib/modules/`uname -r`/updates/drm.ko || return 1
  install -D -m 0644 ${srcdir}/master-compat/drivers/gpu/drm/nouveau/nouveau.ko ${pkgdir}/lib/modules/`uname -r`/kernel/drivers/video/nouveau.ko || return 1
  install -D -m 0644 ${srcdir}/master-compat/drivers/gpu/drm/ttm/ttm.ko ${pkgdir}/lib/modules/`uname -r`/updates/ttm.ko || return 1
  install -D -m 0644 ${srcdir}/master-compat/drivers/gpu/drm/i2c/ch7006.ko ${pkgdir}/lib/modules/`uname -r`/updates/ch7006.ko || return 1
  install -D -m 0644 ${srcdir}/master-compat/include/drm/nouveau_drm.h ${pkgdir}/usr/include/nouveau_drm.h || return 1

  # install script
  sed -i -e "s/KERNEL_VERSION='.*'/KERNEL_VERSION='${_kernver}'/" ${startdir}/${pkgname}.install
}
