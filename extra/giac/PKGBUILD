# Maintainer: Antonio Rojas <arojas@archlinux.org>

# ALARM: Kevin Mihelich <kevin@archlinxuarm.org>
#  - delete shipped x86 binary src/mkjs to force rebuild for ARM

pkgname=giac
_pkgver=2.0.0-19
pkgver=${_pkgver//-/.}
pkgrel=1
pkgdesc='A free computer algebra system'
arch=(x86_64)
url='https://www-fourier.univ-grenoble-alpes.fr/~parisse/giac.html'
license=(GPL-3.0-only)
depends=(blas
         curl
         fltk1.3
         gcc-libs
         glibc
         glpk
         gmp
         gmp-ecm
         gsl
         hicolor-icon-theme
         lapack
         libao
         libglvnd
         libpng
         libsamplerate
         mpfi
         mpfr
         nauty
         ntl
         pari
         readline
         zlib)
makedepends=(hevea
             libjpeg-turbo
             python
             texlive-latexrecommended
             texlive-mathscience)
optdepends=('perl: for pgiac')
source=(https://www-fourier.univ-grenoble-alpes.fr/~parisse/debian/dists/stable/main/source/${pkgname}_$_pkgver.tar.gz)
sha256sums=('edfb8a57cc4d943c8df616b5f8d34752314f8443f4359ded8704572f591c0391')

prepare() {
  cd $pkgname-${pkgver%.*}
  rm -f src/mkjs # force rebuild for ARM
  autoreconf -fiv
}

build() {
  cd $pkgname-${pkgver%.*}

  # this uses malloc_usable_size, which is incompatible with fortification level 3
  export CFLAGS="${CFLAGS/_FORTIFY_SOURCE=3/_FORTIFY_SOURCE=2} -I/usr/include/fltk1.3"
  export CXXFLAGS="${CXXFLAGS/_FORTIFY_SOURCE=3/_FORTIFY_SOURCE=2} -I/usr/include/fltk1.3"

  CXXFLAGS+=" -Wp,-U_GLIBCXX_ASSERTIONS" # Fix crashes
  LDFLAGS+=" -L/usr/lib/fltk1.3"
  ./configure --prefix=/usr
  # prevent excessive overlinking due to libtool
  sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool
  make
}

package() {
  cd $pkgbase-${pkgver%.*}
  make DESTDIR="$pkgdir" install
}
