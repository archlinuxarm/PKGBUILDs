# Maintainer: Carl Smedstad <carsme@archlinux.org>
# Contributor: Florian Pritz <bluewind@xinu.at>
# Contributor: Eric BÃ©langer <eric@archlinux.org>

# ALARM: Kevin Mihelich <kevin@archlinuxarm.org>
#  - move gperf from checkdepends to makedepends

pkgbase=syslog-ng
pkgname=(
  syslog-ng
  syslog-ng-python
  syslog-ng-amqp
  syslog-ng-geoip2
  syslog-ng-kafka
  syslog-ng-mongodb
  syslog-ng-redis
  syslog-ng-smtp
  syslog-ng-snmp
  syslog-ng-sql
)
pkgver=4.10.2
pkgrel=6
pkgdesc="Next-generation syslogd with advanced networking and filtering capabilities"
arch=(x86_64)
url="https://github.com/syslog-ng/syslog-ng"
license=(
  GPL-2.0-or-later
  LGPL-2.1-or-later
)
makedepends=(
  abseil-cpp
  autoconf-archive
  bash
  curl
  docbook-xsl
  gawk
  gcc-libs
  git
  glib2
  glibc
  gperf
  grpc
  hiredis
  json-c
  libcap
  libdbi
  libesmtp
  libmaxminddb
  libnet
  librabbitmq-c
  librdkafka
  libxslt
  mongo-c-driver
  net-snmp
  openssl
  pcre2
  protobuf
  python
  python-boto3
  python-botocore
  python-cachetools
  python-certifi
  python-charset-normalizer
  python-dateutil
  python-google-auth
  python-idna
  python-kubernetes
  python-oauthlib
  python-ply
  python-pyasn1
  python-pyasn1-modules
  python-pyyaml
  python-requests
  python-requests-oauthlib
  python-rsa
  python-setuptools
  python-urllib3
  python-websocket-client
  systemd
  systemd-libs
  zlib
)
checkdepends=(
  criterion
  python-pytest
  python-pytest-mock
)
source=(
  "git+$url.git#tag=$pkgbase-$pkgver"
  "git+https://github.com/balabit/ivykis.git"
  "git+https://github.com/open-telemetry/opentelemetry-proto.git"
  "git+https://github.com/Thalhammer/jwt-cpp.git"
  "$pkgbase.logrotate"
  "$pkgbase-systemd-integration.patch"
  "$pkgbase-do-not-install-python-venv.patch"
  "$pkgbase-config.patch"
)
sha256sums=('8542b1347942602bbf7a084ff82a08779fcbb9d0116636f0fb77b4c53a4687b4'
            'SKIP'
            'SKIP'
            'SKIP'
            '93c935eca56854011ea9e353b7a1da662ad40b2e8452954c5b4b5a1d5b2d5317'
            '12e7d38ca2b79aae9417207a7b3a777f8f7646cc23bddfd383a6a6e9b7014d6e'
            '7ca7f0d9fb203b3814fe2f609904af84df346b84591eeeb171bb2e5eb6393990'
            '1039550b091df1a50e8d30b624d52a7fd56c29d0ceec596b4b029a7cc92a3825')

prepare() {
  cd $pkgbase
  git submodule init
  git config submodule.lib/ivykis.url "$srcdir/ivykis"
  git config submodule.modules/grpc/protos/opentelemetry-proto.url "$srcdir/opentelemetry-protos"
  git config submodule.modules/cloud-auth/jwt-cpp.url "$srcdir/jwt-cpp"
  git -c protocol.file.allow=always submodule update

  # Fix paths for systemd integration.
  patch -Np1 < ../$pkgbase-systemd-integration.patch
  # Don't install Python venv using pip.
  patch -Np1 < ../$pkgbase-do-not-install-python-venv.patch
  # Add further distribution examples, disable default log file.
  patch -Np1 < ../$pkgbase-config.patch

  # afsnmp: seems the latest brew net-snmp version cflags causes
  git cherry-pick -n \
    'b1ccb9932ee3583bb861d499f4ec554d97934ded'

  # Remove tests failing in a chroot but not on host. Not sure why.
  sed -i '/include lib\/secret-storage\/tests\/Makefile.am/d' lib/secret-storage/Makefile.am
  rm -r lib/secret-storage/tests

  ./autogen.sh
}

build() {
  cd $pkgbase
  local configure_options=(
    --datadir=/usr/share
    --disable-java
    --disable-java-modules
    --disable-mqtt
    --disable-riemann
    --enable-all-modules
    --enable-ipv6
    --enable-manpages
    --enable-spoof-source
    --enable-systemd
    --libexecdir=/usr/lib
    --localstatedir="/var/lib/$pkgbase"
    --prefix=/usr
    --sbindir=/usr/bin
    --sysconfdir="/etc/$pkgbase"
    --with-jsonc=system
    --with-pidfile-dir=/run
    --with-python-packages=system
    --with-systemdsystemunitdir=/usr/lib/systemd/system
  )
  ./configure "${configure_options[@]}"

  # Prevent excessive overlinking due to libtool.
  sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool
  make
}

check() {
  cd $pkgbase
  make check
}

_pick() {
  local dest="$1"
  shift
  for obj in "$@"; do
    mkdir -p "$dest/$(dirname "$obj")/"
    mv -v -t "$dest/$(dirname "$obj")/" "$obj"
  done
}

package_syslog-ng() {
  depends=(
    abseil-cpp
    bash
    curl
    gawk
    gcc-libs
    glib2
    glibc
    grpc
    json-c
    libcap
    libnet
    openssl
    pcre2
    protobuf
    systemd-libs
    zlib
  )
  optdepends=('logrotate: for rotating log files')
  conflicts=(eventlog)
  replaces=(eventlog)
  backup=(
    "etc/$pkgname/$pkgname.conf"
    "etc/logrotate.d/$pkgname"
    "etc/default/$pkgname@default"
  )
  install=$pkgbase.install

  cd $pkgbase
  make DESTDIR="$pkgdir" install
  install -vDm644 -t "$pkgdir/etc/default" "contrib/systemd/$pkgname@default"
  install -vdm755 "$pkgdir/var/lib/$pkgname"
  install -vDm644 "$srcdir/$pkgname.logrotate" "$pkgdir/etc/logrotate.d/$pkgname"

  cd "$pkgdir"
  _pick "$srcdir/syslog-ng-python" \
    etc/syslog-ng/python \
    usr/lib/syslog-ng/libmod-python.so \
    usr/lib/syslog-ng/python \
    usr/share/syslog-ng/include/scl/python

  _pick "$srcdir/syslog-ng-amqp" usr/lib/syslog-ng/libafamqp.so
  _pick "$srcdir/syslog-ng-geoip2" usr/lib/syslog-ng/libgeoip2-plugin.so
  _pick "$srcdir/syslog-ng-kafka" usr/lib/syslog-ng/libkafka.so
  _pick "$srcdir/syslog-ng-mongodb" usr/lib/syslog-ng/libafmongodb.so
  _pick "$srcdir/syslog-ng-redis" usr/lib/syslog-ng/libredis.so
  _pick "$srcdir/syslog-ng-smtp" usr/lib/syslog-ng/libafsmtp.so
  _pick "$srcdir/syslog-ng-snmp" usr/lib/syslog-ng/libafsnmp.so
  _pick "$srcdir/syslog-ng-sql" usr/lib/syslog-ng/libafsql.so
}

package_syslog-ng-python() {
  pkgdesc+=" (Python modules)"
  groups=(syslog-ng-modules)
  depends=(
    glib2
    glibc
    python
    syslog-ng
  )
  optdepends=(
    'python-boto3: for S3 module'
    'python-botocore: for S3 module'
    'python-kubernetes: for Kubernetes module'
    'python-ply: for debugger CLI'
    'python-requests: for hypr module'
  )

  cp -va -t "$pkgdir" "$pkgname/"*
}

package_syslog-ng-amqp() {
  pkgdesc+=" (AMQP module)"
  groups=(syslog-ng-modules)
  depends=(
    glib2
    glibc
    librabbitmq-c
    syslog-ng
  )

  cp -va -t "$pkgdir" "$pkgname/"*
}

package_syslog-ng-geoip2() {
  pkgdesc+=" (GeoIP2 module)"
  groups=(syslog-ng-modules)
  depends=(
    glib2
    glibc
    libmaxminddb
    syslog-ng
  )

  cp -va -t "$pkgdir" "$pkgname/"*
}

package_syslog-ng-kafka() {
  pkgdesc+=" (Kafka module)"
  groups=(syslog-ng-modules)
  depends=(
    glib2
    glibc
    librdkafka
    syslog-ng
  )

  cp -va -t "$pkgdir" "$pkgname/"*
}

package_syslog-ng-mongodb() {
  pkgdesc+=" (MongoDB module)"
  groups=(syslog-ng-modules)
  depends=(
    glib2
    glibc
    mongo-c-driver
    syslog-ng
  )

  cp -va -t "$pkgdir" "$pkgname/"*
}

package_syslog-ng-redis() {
  pkgdesc+=" (Redis module)"
  groups=(syslog-ng-modules)
  depends=(
    glib2
    glibc
    hiredis
    syslog-ng
  )

  cp -va -t "$pkgdir" "$pkgname/"*
}

package_syslog-ng-smtp() {
  pkgdesc+=" (SMTP module)"
  groups=(syslog-ng-modules)
  depends=(
    glib2
    glibc
    libesmtp
    syslog-ng
  )

  cp -va -t "$pkgdir" "$pkgname/"*
}

package_syslog-ng-snmp() {
  pkgdesc+=" (SNMP module)"
  groups=(syslog-ng-modules)
  depends=(
    glib2
    glibc
    net-snmp
    syslog-ng
  )

  cp -va -t "$pkgdir" "$pkgname/"*
}

package_syslog-ng-sql() {
  pkgdesc+=" (SQL module)"
  groups=(syslog-ng-modules)
  depends=(
    glib2
    glibc
    libdbi
    openssl
    syslog-ng
  )

  cp -va -t "$pkgdir" "$pkgname/"*
}
