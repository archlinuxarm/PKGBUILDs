# Maintainer: Ettore Chimenti <ek5.chimenti@gmail.com>

pkgname=xf86-video-vivante-dri
pkgver=3.0.35_4.0.0
pkgrel=1
epoch=0
pkgdesc="Binary files for Vivante GPU for i.MX6Q"
arch=('armv7h')
url="http://opensource.freescale.com/"
license=('unknown')
groups=()
depends=('gpu-viv-bin-mx6q' 'randrproto' 'xorg-server-devel' 'xorg-util-macros' 'xorg-server')
makedepends=()
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=
realname="xserver-xorg-video-imx-viv"
source=(http://download.ossystems.com.br/bsp/freescale/source/$realname-${pkgver//_/-}.tar.gz
	add_libdrm_dependency.patch
	dri_m4.patch
	exa_m4.patch
	vivante_common.h.patch
	vivante_dri_port_to_new_server.patch
	vivante_fbdev_port_to_compact_api_for_new_server.patch)
noextract=()
md5sums=('5c5b5be029b077346610518bb729c012'
         '5618c1733fab352137c3ea381ddf8762'
         'd60a258f528af14679caf2957b3ad8c7'
         '6491a8a07a29738da15d17a2374e7789'
         '3bb73e6ab7fda37f204416fa2ece2877'
         '515436c098b1274eb1289c98f965e3d2'
         'a9b2eaf1d082284135930b21e5f19242'
	 )
prepare(){
	patch "$srcdir/$realname-${pkgver//_/-}/EXA/configure.ac" < exa_m4.patch	
	patch "$srcdir/$realname-${pkgver//_/-}/DRI_1.10.4/configure.ac" < dri_m4.patch
	patch "$srcdir/$realname-${pkgver//_/-}/EXA/src/vivante_util/vivante_common.h" < vivante_common.h.patch
	patch "$srcdir/$realname-${pkgver//_/-}/DRI_1.10.4/configure.ac" < add_libdrm_dependency.patch
	patch -p1 < vivante_fbdev_port_to_compact_api_for_new_server.patch || echo 0
	patch -p1 < vivante_dri_port_to_new_server.patch || echo 0

	sed -i -e "s/--prefix=\/usr/--prefix=${pkgdir//\//\\/}\/usr/" "$srcdir/$realname-${pkgver//_/-}/EXA/viv-configure.sh" 
	sed -i -e "s/\$libdir\/xorg\/modules/${pkgdir//\//\\/}\/usr\/lib\/xorg\/modules/" "$srcdir/$realname-${pkgver//_/-}/EXA/configure.ac" 
	sed -i -e "s/--prefix=\/usr/--prefix=${pkgdir//\//\\/}\/usr/" "$srcdir/$realname-${pkgver//_/-}/DRI_1.10.4/viv-configure.sh" 
	sed -i -e "s/\$libdir\/xorg\/modules/${pkgdir//\//\\/}\/usr\/lib\/xorg\/modules/" "$srcdir/$realname-${pkgver//_/-}/DRI_1.10.4/configure.ac" 
} 

build(){
	cd "$srcdir/$realname-${pkgver//_/-}"
	./build.sh
}

package() {
	cd "$srcdir/$realname-${pkgver//_/-}" 
	./install.sh
	find $pkgdir -name "*.la" -delete 
}
