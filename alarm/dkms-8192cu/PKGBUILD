# Maintainer: Runnytu < runnytu at gmail.com >
# Contributor: Christian Hammacher < bmasterc@gmail.com >

pkgname=dkms-8192cu
pkgver=v4.0.2_9000.20130911
pkgrel=2.1
pkgdesc="Driver for Realtek RTL8188CUS (8188C, 8192C) chipset wireless cards"
arch=('arm')
url="http://www.realtek.com.tw/"
license=('GPL')
depends=('dkms' 'linux-headers')
conflicts=("8192cu" "rt8192cu")
install=${pkgname}.install
options=(!strip)
_pkgname="8192cu"
source=("http://sources.libreelec.tv/RTL${_pkgname^^}-${pkgver}.tar.xz"
        "dkms-8192cu.install"
        "RTL8192CU-add_device_ID_330d.patch"
        "RTL8192CU-add_more_products.patch"
        "RTL8192CU-fix_310_proc2.patch"
        "RTL8192CU-gcc-4.9.patch"
        "RTL8192CU-gcc-5.patch"
        "RTL8192CU-kernel-4.0.patch"
        "RTL8192CU-kernel-4.6.patch"
        "RTL8192CU-kernel-4.7.patch"
        "RTL8192CU-kernel-4.8.patch"
        "dkms.conf"
        "blacklist-${pkgname}.conf")
               
md5sums=('89fc503a4ab4bed5481a4bf58bc5f66e'
         '82db3ab6573dbe2ede43e49ac35259cb'
         'd7b6f23eeb84ee7943e73be4124f2565'
         '277b73d4484bb12f771178f2319e128d'
         '555c25c2723fbd8b9d9eac7c56c17722'
         '02a4549a693f3b8a95577ac53291dbdb'
         '732f7281d053675c077380cee41678b8'
         '9198cd09ea5abd42d7f51b61e011970e'
         'c84ffb70c2cd74e60c740295b6aa0b6e'
         '782cb3c9fb345c5a579d563f1a4aea27'
         'd9758b8caf048d79cecc2f9dee6813cd'
         '21077239f17639254b74d74daea8655b'
         '22c70a3107faab69cc3e6604bdeb6cba')

package() {
       
        installDir="$pkgdir/usr/src/${_pkgname}-${pkgver}"
       
        install -dm755 "$installDir"
        install -m644 "$srcdir/dkms.conf" "$installDir/dkms.conf"
        install -dm755 "$pkgdir/etc/modprobe.d"
        install -m644 "$srcdir/blacklist-${pkgname}.conf" "$pkgdir/etc/modprobe.d/blacklist-${pkgname}.conf"
       
        cd "${srcdir}/RTL${_pkgname^^}-${pkgver}/"

	patch -p1 -i ${srcdir}/RTL8192CU-add_device_ID_330d.patch
	patch -p1 -i ${srcdir}/RTL8192CU-add_more_products.patch
	patch -p1 -i ${srcdir}/RTL8192CU-fix_310_proc2.patch
	patch -p1 -i ${srcdir}/RTL8192CU-gcc-4.9.patch
	patch -p1 -i ${srcdir}/RTL8192CU-gcc-5.patch
	patch -p1 -i ${srcdir}/RTL8192CU-kernel-4.0.patch
	patch -p1 -i ${srcdir}/RTL8192CU-kernel-4.6.patch
	patch -p1 -i ${srcdir}/RTL8192CU-kernel-4.7.patch
	patch -p1 -i ${srcdir}/RTL8192CU-kernel-4.8.patch

	# Disable power saving
	sed -i 's/^CONFIG_POWER_SAVING \= y/CONFIG_POWER_SAVING = n/' Makefile

	# Fix __TIME__ macros error
	sed -i 's/^#define CONFIG_DEBUG_RTL819X/\ /' include/autoconf.h 

        for d in `find . -type d`
        do
                install -dm755  "$installDir/$d"
        done
       
        for f in `find . -type f`
        do
                install -m644 "${srcdir}/RTL${_pkgname^^}-${pkgver}/$f" "$installDir/$f"
        done
       
}
