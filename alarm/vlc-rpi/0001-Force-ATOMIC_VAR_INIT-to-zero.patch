From 914e0545e35b3f94d820408ba34a3d309d01f045 Mon Sep 17 00:00:00 2001
From: graysky <therealgraysky AT proton DOT me>
Date: Tue, 16 Dec 2025 14:19:35 -0500
Subject: [PATCH] drmu: remove deprecated ATOMIC_VAR_INIT usage

ATOMIC_VAR_INIT was deprecated in C17 and removed in C++20.
Modern compilers no longer need this macro as static atomic
variables are guaranteed to initialize properly with direct
initialization.

This fixes compilation errors with GCC on systems defaulting
to C17 standard or newer.

Debian's patches reintroduced aspects of it.

Refs #1658

---
 modules/hw/mmal/mmal_cma.c            | 2 +-
 modules/hw/mmal/mmal_cma_drmprime.c   | 2 +-
 modules/video_output/drmu/drmu_poll.c | 2 +-
 modules/video_output/drmu/pollqueue.c | 2 +-
 src/misc/threads.c                    | 2 +-
 5 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/modules/hw/mmal/mmal_cma.c b/modules/hw/mmal/mmal_cma.c
index 4dfedbc57cf9..9a73e14ab3a7 100644
--- a/modules/hw/mmal/mmal_cma.c
+++ b/modules/hw/mmal/mmal_cma.c
@@ -405,7 +405,7 @@ static void * cma_pool_alloc_cb(void * v, size_t size)
         return NULL;
 
     *cb = (cma_buf_t){
-        .ref_count = ATOMIC_VAR_INIT(0),
+        .ref_count = 0,
         .cbp = cbp,
         .in_flight = 0,
         .size = size,
diff --git a/modules/hw/mmal/mmal_cma_drmprime.c b/modules/hw/mmal/mmal_cma_drmprime.c
index d58bfdd9443d..123024234e63 100644
--- a/modules/hw/mmal/mmal_cma_drmprime.c
+++ b/modules/hw/mmal/mmal_cma_drmprime.c
@@ -36,7 +36,7 @@ static void * drmprime_pool_alloc_cb(void * v, size_t size)
 
     *cdb = (cma_drmprime_buf_t){
         .cb = {
-            .ref_count = ATOMIC_VAR_INIT(0),
+            .ref_count = 0,
             .cbp = cbp,
             .in_flight = 0,
             .size = size,
diff --git a/modules/video_output/drmu/drmu_poll.c b/modules/video_output/drmu/drmu_poll.c
index 7f9d2f8c08bd..bf378c39713e 100644
--- a/modules/video_output/drmu/drmu_poll.c
+++ b/modules/video_output/drmu/drmu_poll.c
@@ -334,7 +334,7 @@ drmu_queue_new(struct drmu_env_s * const du)
 {
     drmu_queue_t * const aq = calloc(1, sizeof(*aq));
     pthread_condattr_t condattr;
-    static atomic_int qcount = ATOMIC_VAR_INIT(0);
+    static atomic_int qcount = 0;
 
     if (aq == NULL)
         return NULL;
diff --git a/modules/video_output/drmu/pollqueue.c b/modules/video_output/drmu/pollqueue.c
index c8a4de0be14f..5066f1212233 100644
--- a/modules/video_output/drmu/pollqueue.c
+++ b/modules/video_output/drmu/pollqueue.c
@@ -468,7 +468,7 @@ struct pollqueue * pollqueue_new(void)
     if (!pq)
         return NULL;
     *pq = (struct pollqueue){
-        .ref_count = ATOMIC_VAR_INIT(0),
+        .ref_count = 0,
         .lock = PTHREAD_MUTEX_INITIALIZER,
         .cond = PTHREAD_COND_INITIALIZER,
         .head = NULL,
diff --git a/src/misc/threads.c b/src/misc/threads.c
index a6183cb26fb2..1052c4dc7c67 100644
--- a/src/misc/threads.c
+++ b/src/misc/threads.c
@@ -83,7 +83,7 @@ static void vlc_cancel_addr_finish(void *addr)
 void (mwait)(vlc_tick_t deadline)
 {
     vlc_tick_t delay;
-    atomic_int value = ATOMIC_VAR_INIT(0);
+    atomic_int value = 0;
 
     vlc_cancel_addr_prepare(&value);
 
-- 
2.52.0

