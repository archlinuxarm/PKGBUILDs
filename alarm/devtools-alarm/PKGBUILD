# Maintainer: Levente Polyak <anthraxx[at]archlinux[dot]org>
# Maintainer: Christian Heusel <gromit@archlinux.org>
# Contributor: Pierre Schmitz <pierre@archlinux.de>

# ALARM: Kevin Mihelich <kevin@archlinuxarm.org>
#  - patches to fix issues with how we use the tools

pkgname=devtools-alarm
_pkgname=devtools
epoch=1
pkgver=1.4.0
pkgrel=3
pkgdesc='Tools for Arch Linux ARM package maintainers'
arch=('any')
license=('GPL-3.0-or-later')
url='https://gitlab.archlinux.org/archlinux/devtools'
conflicts=('devtools')
provides=('devtools')
depends=(
  arch-install-scripts
  awk
  bash
  binutils
  coreutils
  curl
  diffutils
  expac
  fakeroot
  findutils
  glow
  grep
  gum
  jq
  openssh
  parallel
  reuse
  rsync
  sed
  util-linux
  sudo
  breezy
  git
  mercurial
  subversion
)
makedepends=(
  asciidoctor
)
checkdepends=(
  bats
)
optdepends=(
  'btrfs-progs: btrfs support'
  'bat: pretty printing for pkgctl search'
  'nvchecker: pkgctl version subcommand'
)
source=(https://gitlab.archlinux.org/archlinux/devtools/-/releases/v${pkgver}/downloads/devtools-${pkgver}.tar.gz{,.sig}
        0001-makechrootpkg-cache-dir.patch
        0002-arch-nspawn-keep-mirrorlist.patch
        0003-makechrootpkg-distcc.patch
        0004-arch-nspawn-arm-fix.patch
        0005-makechrootpkg-no-default-logging.patch
        0006-archbuild-no-setarch.patch
        0007-makechrootpkg-don-t-delete-MAKEFLAGS-and-PACKAGER.patch
        0008-makechrootpkg-gotmpdir.patch)
validpgpkeys=(
  'E240B57E2C4630BA768E2F26FC1B547C8D8172C8' # Levente Polyak <anthraxx@archlinux.org>
  'F00B96D15228013FFC9C9D0393B11DAA4C197E3D' # Christian Heusel (gromit packager key) <gromit@archlinux.org>
)
sha256sums=('8ea6c752ec6dc2823a271b94a73ab5dd22acb16218d644783d515f7d8b03e19a'
            'SKIP'
            '9c000e2317d16079b74f87c4157fcd662b1f8a777f02675e8697c045a15f008e'
            '218ca7282f7b5c3fe55c2b29849c4dc82e7f1d192be8a036866937348f3fd0ad'
            'da7c0ff5b92f555098cf22e1168c5dc59da88692e97351b5ea50dfcfae80abb0'
            '98999e19d597d5c5f48a5f9cdc5c702fac7dc5c7745c118871753670a0a69718'
            '62bd899979b008cddc36419924bf96b0059fac1dd83ca110eb5c56a56aef77fb'
            '6dfe5b2e27444afeb1681ce780905e08b16f4ec4a10d517d4f3ca0f77b1dd99e'
            '281a41e1291781e520baa09d1f873ebb2337559d998fac0d77e096bad9b9f88c'
            'e3987720b74aff75618555dd6c0d02f23debc13c7a6e4cb8289e57475d9e3307')
b2sums=('9850382d2f6329e7fb958ef01178b7cd8bfcc148aad00ed07578382744b64b049e1c907febea5fb27381a270a742e4149e9995ef724ce222ee1afe9a939fb5ca'
        'SKIP'
        'd9745f7cb7a8b9bcc2f54ecaad5b0ea1c0bfd978e1c11e56491fb816b163000563ba9476269e86271ce1e7e5300f337c6477e8d99f1ecd24c04a03d6af4cecf1'
        'f00b30b225499bcd71343e9f0860379d5756bf3353ebcf299221c521ab0f2090942d433313e27c80a036120366d7032c5faa3c90f0fb8e7921eab9f3af4e12f5'
        '30ce81cb8091edd1c5d25a46cf5c0778d8d16d93dec38431d938ed5e0aa50d253295281b3e1139cff06faf6c963b2304f11183fdf5fc686b30c30107ed92a05b'
        '2f0018535f1138ddd3994580a9f23f04cdb9435bca2c3a9f60736098c1d406813b4bcadd3e39f70c8f7c06406afca037bfa420f6f69fa56f7540d71565907ffd'
        'b08f1b5bba8b91b7054849af7a0f8814510814c51193e97c45b77e68ad7469beea94ef6c0ced336cce36f46e279bef39a7cfb9bf705fb210349c7f0c92ff5ebf'
        '816fdf57c9108d6547114c38c910fb2b89781eadafeab698ea6dd439c9072e2356c02af561dfb79185910ac75149558b01f0112081c12e2b66cb9772ce82e3e3'
        '370a6658f9674749cf63d8d4e047a812d5858b27927655799d11d81a9b0283fd3b8c50253bbb1e83dc08a9e14febc5a6a79054a237124ea7610e1cc2517dcc82'
        '66e8ac8c9dbc0cc948c51d469a2e97f2181dbb0e37033ca48d5781a869f0928ac1d2d188f279a955c12a6aad9a5dcf1e6d93f3f5daea4252e6c36778970568d8')

prepare() {
  cd ${_pkgname}-${pkgver}
  patch -p1 -i ../0001-makechrootpkg-cache-dir.patch
  patch -p1 -i ../0002-arch-nspawn-keep-mirrorlist.patch
  patch -p1 -i ../0003-makechrootpkg-distcc.patch
  patch -p1 -i ../0004-arch-nspawn-arm-fix.patch
  patch -p1 -i ../0005-makechrootpkg-no-default-logging.patch
  patch -p1 -i ../0006-archbuild-no-setarch.patch
  patch -p1 -i ../0007-makechrootpkg-don-t-delete-MAKEFLAGS-and-PACKAGER.patch
  patch -p1 -i ../0008-makechrootpkg-gotmpdir.patch
}

build() {
  cd ${_pkgname}-${pkgver}
  make BUILDTOOLVER="${epoch}:${pkgver}-${pkgrel}-${arch}" PREFIX=/usr
}

check() {
  cd ${_pkgname}-${pkgver}
  make PREFIX=/usr test
}

package() {
  cd ${_pkgname}-${pkgver}
  make PREFIX=/usr DESTDIR="${pkgdir}" install
}

# vim: ts=2 sw=2 et:
