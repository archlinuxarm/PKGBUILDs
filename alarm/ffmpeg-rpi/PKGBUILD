# Maintainer: graysky <therealgraysky AT proton DOT me>
# Contributor: Bart≈Çomiej Piotrowski <bpiotrowski@archlinux.org>
# Contributor: Ionut Biru <ibiru@archlinux.org>
# Contributor: Tom Newsom <Jeepster@gmx.co.uk>
# Contributor: Paul Mattal <paul@archlinux.org>

pkgbase=ffmpeg-rpi
pkgname=($pkgbase $pkgbase-bin)
pkgver=7.1.2
pkgrel=1
arch=(aarch64)
url=https://ffmpeg.org/
license=(GPL3)
makedepends=(
  amf-headers
  avisynthplus
  clang
  debugedit
  frei0r-plugins
  git
  ladspa
  mesa
  nasm
  opencl-headers
  vulkan-headers
)
depends=(
    alsa-lib
    aom
    bzip2
    cairo
    dav1d
    fontconfig
    freetype2
    fribidi
    glib2
    glibc
    glslang
    gmp
    gnutls
    gsm
    jack
    lame
    libass.so
    libavc1394
    libbluray.so
    libbs2b
    libdav1d.so
    libdvdnav
    libdvdread
    libdrm
    libgl
    libepoxy
    libjxl
    libfreetype.so
    libiec61883
    libmodplug
    libopenmpt
    libplacebo
    libpulse
    libraw1394
    librsvg-2.so
    libsoxr
    libssh
    libtheora
    libva.so
    libva-drm.so
    libva-x11.so
    libvdpau
    libvidstab.so
    libvorbisenc.so
    libvorbis.so
    libvpx.so
    libwebp
    libx11
    libx264.so
    libx265.so
    libxcb
    libxext
    libxml2
    libxv
    libxvidcore.so
    libzimg.so
    ocl-icd
    opencore-amr
    openjpeg2
    opus
    rav1e
    rubberband
    sdl2
    snappy
    speex
    srt
    v4l-utils
    vapoursynth
    vid.stab
    x264
    x265
    xvidcore
    xz
    zeromq
    zimg
    zlib
)
options=(debug)
source=(
  https://ffmpeg.org/releases/${pkgname/-rpi}-$pkgver.tar.xz{,.asc}
  ffmpeg-7.1.2-rpi_28.patch::https://raw.githubusercontent.com/RPi-Distro/ffmpeg/9bbfbc4628b16582c3c79dd66da1779af5c6ae3e/debian/patches/ffmpeg-7.1.2-rpi_28.patch
  0001-fix-glslang.patch
)
sha256sums=('089bc60fb59d6aecc5d994ff530fd0dcb3ee39aa55867849a2bbc4e555f9c304'
            'SKIP'
            '21781b12275908004a41046fd8e49e1db92bc9ae7ed6d013c035f27b8cb73689'
            'a3264ddf9e56bf454eab1acf8e8921afc702b0860c17f38f21666f859bd3edc8')

prepare() {
  cd "${pkgname/-rpi}-$pkgver"

  local src
  for src in "${source[@]}"; do
    src="${src%%::*}"
    src="${src##*/}"
    [[ $src = *.patch ]] || continue
    echo "Applying patch $src..."
    patch -Np1 < "../$src"
  done
}

build() {
  cd "${pkgname/-rpi}-$pkgver"

  # -march= defined in /etc/makepkg.conf will override the value for -mcpu we
  # uses here so unset them and redefine below
  unset CFLAGS CXXFLAGS

  if [[ $CARCH = "armv7h" ]]; then
    # we use -mcpu=cortex-a53 rather than cortex-a72 to maximize RPi 3B and RPi 4B/400 compatibility
    CFLAGS="-mcpu=cortex-a53 -mfpu=neon-fp-armv8 -mfloat-abi=hard"
  elif [[ $CARCH = "aarch64" ]]; then
    # note that we use a value of cortex-a53 here to allow RPi3 and RPi4 to use the same package
    # consistent with rationale of previous comment
    CFLAGS="-mcpu=cortex-a53"
  fi

  export CFLAGS+=" -O2 -pipe -mno-omit-leaf-frame-pointer -fstack-protector-strong -fno-plt -fexceptions -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security -fstack-clash-protection -fno-omit-frame-pointer"
  export CXXFLAGS+="${CFLAGS} -Wp,-D_GLIBCXX_ASSERTIONS"

  _args=(
    --prefix=/usr
    --incdir=/usr/include/ffmpeg-rpi
    --libdir=/usr/lib/ffmpeg-rpi
    --disable-debug
    --disable-static
    --disable-stripping
    --disable-htmlpages
    --enable-amf
    --enable-avisynth
    --disable-cuda-llvm
    --enable-lto
    --enable-fontconfig
    --enable-frei0r
    --enable-gmp
    --enable-gnutls
    --enable-gpl
    --enable-ladspa
    --enable-libaom
    --enable-libass
    --enable-libbluray
    --enable-libbs2b
    --enable-libdav1d
    --enable-libdrm
    --enable-libdvdnav
    --enable-libdvdread
    --enable-libfreetype
    --enable-libfribidi
    --enable-libglslang
    --enable-libgsm
    --enable-libharfbuzz
    --enable-libiec61883
    --enable-libjack
    --enable-libjxl
    --enable-libmodplug
    --enable-libmp3lame
    --enable-libopencore_amrnb
    --enable-libopencore_amrwb
    --enable-libopenjpeg
    --enable-libopus
    --enable-libplacebo
    --enable-libpulse
    --enable-librav1e
    --enable-librsvg
    --enable-librubberband
    --enable-libsnappy
    --enable-libsoxr
    --enable-libspeex
    --enable-libsrt
    --enable-libssh
    --disable-libsvtav1
    --enable-libtheora
    --enable-libv4l2
    --enable-libvidstab
    --disable-libvmaf
    --enable-libvorbis
    --disable-libvpl
    --enable-libvpx
    --enable-libwebp
    --enable-libx264
    --enable-libx265
    --enable-libxcb
    --enable-libxml2
    --enable-libxvid
    --enable-libzimg
    --enable-libzmq
    --disable-nvenc
    --disable-nvdec
    --enable-opencl
    --enable-opengl
    --enable-shared
    --enable-vapoursynth
    --enable-version3
    --enable-vulkan
    --host-cflags="-fPIC"
  )

  # for hw decoding
  _args+=(
    --disable-mmal
    --enable-neon
    --enable-v4l2-request
    --enable-libudev
    --enable-epoxy
    --enable-sand
  )

  ./configure "${_args[@]}"
  make
  make tools/qt-faststart
}

package_ffmpeg-rpi() {
  pkgdesc='FFmpeg with hw accel for RPi 3/4/400'
  optdepends=(
    'avisynthplus: AviSynthPlus support'
    'ffmpeg-rpi-bin: binaries and man pages'
    'ladspa: LADSPA filters'
  )
  provides=(
    libavcodec.so
    libavdevice.so
    libavfilter.so
    libavformat.so
    libavutil.so
    libpostproc.so
    libswresample.so
    libswscale.so
  )
  conflicts=(ffmpeg4.4)

  make DESTDIR="${pkgdir}" -C "${pkgname/-rpi}-$pkgver" install

  cd "${pkgdir}"

  # Move libs to /usr/lib, except the .so symlinks
  local f
  for f in usr/lib/ffmpeg-rpi/*; do
    if [[ $f == *.so ]]; then
      ln -srf -- usr/lib/"$(readlink "$f")" "$f"
    elif [[ ! -d $f ]]; then
      mv "$f" usr/lib
    fi
  done

  # these go in ffmpeg-rpi-bin
  rm -r usr/share usr/bin
}

package_ffmpeg-rpi-bin() {
  pkgdesc='binaries and man pages'
  depends=(ffmpeg-rpi)
  conflicts=(ffmpeg4.4 ffmpeg)
  provides=(ffmpeg)

  make DESTDIR="${pkgdir}" -C "${pkgname/-rpi-bin}-$pkgver" install install-man

  cd "${pkgdir}"

  # Move libs to /usr/lib, except the .so symlinks
  local f
  for f in usr/lib/ffmpeg-rpi/*; do
    if [[ $f == *.so ]]; then
      ln -srf -- usr/lib/"$(readlink "$f")" "$f"
    elif [[ ! -d $f ]]; then
      mv "$f" usr/lib
    fi
  done

  # these are provided by ffmpeg-rpi
  rm -r usr/include usr/lib
}
# vim:set sw=2 et:
