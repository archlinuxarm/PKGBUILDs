# Maintainer: Krzysztof "hiciu" Warzecha <kwarzecha7@gmail.com>

pkgname=kernel26
pkgver=2.6.29
_gitver=f19f259d3c1afde8eae53983fd19f61831927413
groups=('base' 'small-base')
pkgrel=4
pkgdesc="The Linux Kernel and modules"
arch=(arm)
license=('GPL2')
url="http://wiki.openmoko.org/wiki/Kernel"
depends=('coreutils')
makedepends=('git' 'uboot-mkimage-native')
source=('build' 'append-GTA02')
md5sums=('6a8b9286ac61ba7d4593da23ca21cf0e'
         'ad1cb2f0a3000f5285c58b22fe8f4de3')

build() {
  cd ${srcdir}
  # make this build clean
  if [ -x linux-2.6 ]; then
    cd linux-2.6
    git reset --hard ORIG_HEAD
  else
    git clone git://git.openmoko.org/git/kernel.git linux-2.6
    cd linux-2.6
    git checkout --track -b andy-tracking origin/andy-tracking
  fi
  git checkout ${_gitver}
  rm -rf GTA02
  mkdir GTA02
  cp ./arch/arm/configs/gta02_moredrivers_defconfig GTA02/.config

  sh ${srcdir}/build GTA02 with_modules
  
  mkdir -p ${pkgdir}/boot

  cp -a GTA02/staging/lib ${pkgdir}
  cp GTA02/uImage-moredrivers-*.bin ${pkgdir}/boot
  cd ${pkgdir}/boot
  ln -s uImage-moredrivers-*.bin uImage-GTA02.bin
  cp ${srcdir}/append-GTA02 ${pkgdir}/boot
}
