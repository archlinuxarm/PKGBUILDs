# Maintainer: Mike Staszel <mikestaszel@gmail.com>

# This PKGBUILD builds a kernel using cbxbiker's With-Linux configuration.

pkgname=kernel26-withlinux
pkgver=2.6.34.2
pkgrel=1
pkgdesc="The Linux Kernel and modules from WithLinux, natively compiled"
arch=('arm')
license=('GPL2')
url="http://www.kernel.org"
depends=('coreutils' 'module-init-tools')
makedepends=('uboot-mkimage')
conflicts=('kernel26')
provides=('kernel26')
install=kernel26-withlinux-native.install
source=(http://www.kernel.org/pub/linux/kernel/v2.6/linux-$pkgver.tar.bz2
        http://sheeva.with-linux.com/sheeva/$pkgver/sheeva-$pkgver.config)
md5sums=('d31d241dc2058698a45fe41359cafb45'
         'b92a6df65fc7d1f3780280e5252f83f3')
LDFLAGS=""

build() {
   cd $srcdir/
   ln -s linux-$pkgver linux
   cd linux/
   
   # Prepare for make
   mv $srcdir/sheeva-$pkgver.config .config

   # Make!
   make clean modules uImage || return 1

   # Pack up the created uImage
   mkdir -p $pkgdir/boot
   cp $srcdir/linux/arch/arm/boot/uImage $pkgdir/boot/uImage

   # Make and package kernel modules
   mkdir -p $pkgdir/{lib/modules,boot}
   make INSTALL_MOD_PATH=${pkgdir} modules_install || return 1
}
