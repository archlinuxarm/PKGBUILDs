# Maintainer: Mike Staszel <mikestaszel@gmail.com>

# This PKGBUILD makes a kernel for the DockStar with aholler's LED patches.

pkgname=kernel26-dockstar
pkgver=2.6.35.1
pkgrel=1
pkgdesc="The Linux Kernel and modules with DockStar LEDs"
arch=('arm')
license=('GPL2')
url="http://www.kernel.org"
depends=('coreutils' 'module-init-tools')
makedepends=('uboot-mkimage')
conflicts=('kernel26')
provides=('kernel26')
install=kernel26-dockstar.install
source=(http://www.kernel.org/pub/linux/kernel/v2.6/linux-$pkgver.tar.bz2
        config-2.6.33-dockstar
        0001-MTD-partitons-used-by-the-Seagate-FreeAgent-DockStar.patch
        0002-LED-definitions-for-the-Seagate-FreeAgent-DockStar.patch
        0003-Change-board-name-for-the-SheevaPlug-to-reflect-the-.patch)
md5sums=('27b266dda534761fb027a6c47605b7e3'
         '382c66de008d1bd1d97089b9ca049b6d'
         '0ed85186b0b5446c4afbbc45639a7466'
         'e81eae381cc2c282d169c879cc4da54b'
         '75287077b9a0105156977acb85d57546')
LDFLAGS=""

build() {
   cd $srcdir/
   ln -s linux-$pkgver linux
   cp 000* config-2.6.33-dockstar linux/
   cd linux/
   
   # Apply Aholler's DockStar hardware patches
   patch -p1 -i 0001-MTD-partitons-used-by-the-Seagate-FreeAgent-DockStar.patch 
   patch -p1 -i 0002-LED-definitions-for-the-Seagate-FreeAgent-DockStar.patch
   patch -p1 -i 0003-Change-board-name-for-the-SheevaPlug-to-reflect-the-.patch

   # Prepare for make
   mv config-2.6.33-dockstar .config
   echo "Press ENTER 4972 times..."
   make oldconfig

   # Use it to enable FUSE as a module
   make menuconfig

   # Make!
   make modules uImage || return 1

   # Pack up the created uImage
   mkdir -p $pkgdir/boot
   cp $srcdir/linux/arch/arm/boot/uImage $pkgdir/boot/uImage-dockstar

   # Make and package kernel modules
   mkdir -p $pkgdir/{lib/modules,boot}
   make INSTALL_MOD_PATH=${pkgdir} modules_install || return 1

   echo "To make things safer, you will manually have to move/copy"
   echo "/boot/uImage-dockstar to /boot/uImage after installation."
}
