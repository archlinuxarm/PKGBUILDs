# $Id: PKGBUILD 82 2009-07-17 19:56:55Z aaron $
# Maintainer: Sergej Pupykin <pupykin.s+arch@gmail.com>

pkgname=cross-arm-wince-cegcc-gdbstub
pkgver=0.51.0
pkgrel=1
pkgdesc="CE GCC bundle - cross compilation tools for WinCE"
arch=(i686 x86_64)
license=(GPL)
options=(!libtool)
url="http://cegcc.sf.net"
depends=('glibc')
groups=('cegcc')
source=(http://st-kuznetsy.ru/sergej/cegcc-$pkgver-src.tar.bz2)
md5sums=('0ed59367a01d0baa04cc941e4bf1c2d1')

_prefix=/opt/cegcc

build() {
  cd ${startdir}/src/cegcc/src/

  export PATH=$_prefix/bin:$PATH
  export TARGET=arm-wince-cegcc
  unset CFLAGS
  unset CXXFLAGS
  unset LDFLAGS
  unset MAKEFLAGS

  STUB_EXE=$startdir/pkg/${_prefix}/bin/${TARGET}-stub.exe
  STUB_SRC=`pwd`/gdb/gdb/wince-stub.c

  # pass -static so the stub doesn't depend on cegcc.dll. 
  # Useful for debugging cegcc.dll itself.
  # Actually, the stub would better be built with -mno-cegcc/arm-wince-mingw32
  # To remove the newlib/cegcc.dll dependency, since it mostly uses win32 api.
  # Removed for now, as it is giving problems.

  mkdir -p $startdir/pkg/${_prefix}/bin/

  ${TARGET}-gcc -O2 -mwin32    \
           ${STUB_SRC}         \
           -o ${STUB_EXE}      \
           -lwinsock || return 1

  ${TARGET}-strip ${STUB_EXE}
}
