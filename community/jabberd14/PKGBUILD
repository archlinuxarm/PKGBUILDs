# $Id: PKGBUILD 82 2009-07-17 19:56:55Z aaron $
# Maintainer: Sergej Pupykin <pupykin.s+arch@gmail.com>
# Contributor: Sergej Pupykin <pupykin.s+arch@gmail.com>

pkgname=jabberd14
pkgver=1.6.1.1
pkgrel=5
pkgdesc="old (1.4) jabber server branch"
arch=(i686 x86_64)
url="http://jabberd.org/"
license=("GPL")
depends=(libidn pth openssl expat)
conflicts=(jabberd)
backup=(etc/jabberd/jabber.xml)
source=(http://download.jabberd.org/jabberd14/jabberd14-$pkgver.tar.gz \
	jabberd)
md5sums=('597c7ee14518ba22b1cee883b4737d87'
         'e3e672e81e6a70d02d7458e0edd4021c')

build() {
  cd $startdir/src/jabberd14-$pkgver
  ./configure --prefix=/usr --enable-ssl --enable-legacy --sysconfdir=/etc/jabberd --localstatedir=/var

  patch -p0 jabberd/mio_tls.cc <<EOF
615c615,616
< 	    ret = gnutls_certificate_set_openpgp_key_file(current_credentials, pubfile, privfile);
---
> //	    ret = gnutls_certificate_set_openpgp_key_file(current_credentials, pubfile, privfile);
> 	    ret = gnutls_certificate_set_openpgp_key_file(current_credentials, pubfile, privfile, GNUTLS_OPENPGP_FMT_BASE64);
634c635,636
< 	    ret = gnutls_certificate_set_openpgp_keyring_file(current_credentials, file);
---
> //	    ret = gnutls_certificate_set_openpgp_keyring_file(current_credentials, file);
> 	    ret = gnutls_certificate_set_openpgp_keyring_file(current_credentials, file, GNUTLS_OPENPGP_FMT_BASE64);
642a645,646
> 
> /*
658a663
> */
EOF

  make || return 1
  make DESTDIR=$startdir/pkg install && \
  mkdir -p $startdir/pkg/etc/rc.d/ && \
  install -m 0755 $startdir/src/jabberd $startdir/pkg/etc/rc.d/jabberd
}
